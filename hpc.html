
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>On Betzy &#8212; NorESM User Workshop 2021</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/exercise.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Take home messages" href="take_home.html" />
    <link rel="prev" title="On the Virtual Machine" href="virtual_machine.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">NorESM User Workshop 2021</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Running NorESM in a container
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="content.html">
   Objectives of this training
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="virtual_machine.html">
     On the Virtual Machine
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     On Betzy
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="take_home.html">
   Take home messages
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/hpc.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/NordicESMHub/NorESM_user_workshop_2021"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/NordicESMHub/NorESM_user_workshop_2021/issues/new?title=Issue%20on%20page%20%2Fhpc.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-few-words-on-bit-for-bit-reproducibility">
   A few words on Bit-For-Bit reproducibility
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="on-betzy">
<h1>On Betzy<a class="headerlink" href="#on-betzy" title="Permalink to this headline">Â¶</a></h1>
<p>Login on Betzy with your usual Sigma2 <em>username</em> (i.e., you are not <em>ubuntu</em> any more), and proceed like on the Virtual Machine but use <strong>/cluster/work/users/$USER</strong> (which is equivalent to <strong>$USERWORK</strong>) instead of <strong>/home/ubuntu</strong> for staging and job data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ssh -i ~/.ssh/YourPrivateSSHkey YourSigma2UserName@betzy.sigma2.no
$ cd $USERWORK
$ mkdir work archive
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All the necessary inputdata being already available on <strong>/cluster/shared/noresm/inputdata</strong> there is no need to download the Zenodo tarball when you are on Betzy (or Fram)</p>
</div>
<p>Pull the same container image as on the Virtual Machine, <strong>make it executable</strong>, and extract this time the Slurm batch job script <strong>job_hpc.sh</strong></p>
<p>On many systems it is common to use an alternative launcher to start parallel applications, for instance Slurmâs <strong>srun</strong> rather than the <strong>mpirun</strong> <em>wrapper</em> provided by a particular MPI installation (as we did on the Virtual Machine for the âoutside-inâ exercise)</p>
<p>This approach is supported with Singularity as long as the MPI version installed in the container supports the same Process Management Interface (PMI) and version as that used by the launcher (which is the case with our container)</p>
<p>In the frame of this workshop we are therefore going to use <strong>srun</strong> for automatically distributing the processes to precisely the resources allocated to the job, without loading any module with MPI</p>
<div class="exercise admonition" id="1Day-Betzy">
<p class="admonition-title"><span class="caption-number">Exercise 10 </span></p>
<div class="section" id="exercise-content">
<p>Edit the script to set <strong>nodes=1</strong>, <strong>tasks-per-node=16</strong> and specify that we are using the <em>development</em> queue, then  submit the Slurm job which will run NorESM for <strong>1 day</strong> on <strong>1x node</strong> and <strong>16x CPUs</strong>.</p>
<p>Monitor the execution and once the simulation has finished check the timing profile</p>
</div>
</div><div class="solution dropdown admonition" id="hpc-solution-1">
<p class="admonition-title"><span class="caption-number"></span><a class="reference internal" href="#1Day-Betzy"><span>Solution to </span> Exercise 10</a></p>
<div class="section" id="solution-content">
<p><img alt="" src="_images/Betzy_Jobx16.png" /></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sbatch job_hpc.sh
</pre></div>
</div>
<p><img alt="" src="_images/Timing-Betzy.png" /></p>
</div>
</div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>Short simulations do not necessarily provide the most representative performance figures therefore, for the purpose of benchmarking, longer simulations are normally performed (typically 1 month or more)</p>
</div>
<div class="exercise admonition" id="1Month-Betzy">
<p class="admonition-title"><span class="caption-number">Exercise 11 </span></p>
<div class="section" id="exercise-content">
<p>Edit the script to set <strong>nodes=8</strong> and <strong>tasks-per-node=128</strong>, delete the line with <strong>- - qos</strong> (in order to use the <em>normal</em> queue), change the name of the machine to <strong>âcontainerâ</strong> and replace ândaysâ by <strong>ânmonthsâ</strong>, then resubmit the job to get a more precise estimate of the model throughput</p>
</div>
</div><div class="solution dropdown admonition" id="hpc-solution-3">
<p class="admonition-title"><span class="caption-number"></span><a class="reference internal" href="#1Month-Betzy"><span>Solution to </span> Exercise 11</a></p>
<div class="section" id="solution-content">
<p><img alt="" src="_images/Betzy_Job_8x128.png" /></p>
<p><img alt="" src="_images/Timing-Betzy_8x128.png" /></p>
</div>
</div><div class="exercise admonition" id="To_think_about">
<p class="admonition-title"><span class="caption-number">Exercise 12 </span></p>
<div class="section" id="exercise-content">
<p>To thing about: which of the 1x16 or 8x128 CPU runs provides the best <em>value-for-money</em>?</p>
</div>
</div><div class="solution dropdown admonition" id="hpc-solution-5">
<p class="admonition-title"><span class="caption-number"></span><a class="reference internal" href="#To_think_about"><span>Solution to </span> Exercise 12</a></p>
<div class="section" id="solution-content">
<p>The <strong>scalability</strong> being what it is, the more tasks are involved in the computation the more time is spent in communications rather than calculations, especially when several nodes are put to work (the bandwidth and latency are generally much better within a single node than inter-nodes), and therefore the performance declines rapidly</p>
<ul class="simple">
<li><p>This also applies to bare-metal, not only to containers</p></li>
<li><p>Always try to find the <strong>sweet spot</strong> for your simulation, depending on the compset and resolution used</p></li>
<li><p>Unless there are short deadlines to meet, it is not sensible or economical (or environmentally friendly) to perform your experiment with the largest number of CPUs possible.</p></li>
</ul>
</div>
</div><div class="section" id="a-few-words-on-bit-for-bit-reproducibility">
<h2>A few words on Bit-For-Bit reproducibility<a class="headerlink" href="#a-few-words-on-bit-for-bit-reproducibility" title="Permalink to this headline">Â¶</a></h2>
<p>Are NorESM simulations always identical on platforms with different hardware and software configurations?</p>
<div class="exercise admonition" id="BFB-Reproducibility">
<p class="admonition-title"><span class="caption-number">Exercise 13 </span></p>
<div class="section" id="exercise-content">
<p>The short answer is âNo!â when running on bare metal, but what happens when using a container?</p>
<p>We already had a look at outputs from the âoutside-inâ and âinside-outâ simulations carried out with the container on the Virtual Machine with x16 <strong>IntelÂ® Haswell</strong> processors.</p>
<p>How does that compare to the run on Betzy this time with x16 <strong>AMDÂ® Rome</strong> processors?</p>
</div>
</div><div class="solution dropdown admonition" id="hpc-solution-7">
<p class="admonition-title"><span class="caption-number"></span><a class="reference internal" href="#BFB-Reproducibility"><span>Solution to </span> Exercise 13</a></p>
<div class="section" id="solution-content">
<p>Virtual Machine 1x16 VCPUs <strong>IntelÂ® Haswell</strong></p>
<p><img alt="" src="_images/VMx16_log.png" /></p>
<p>Betzy HPC 1x16 CPUs <strong>AMDÂ® Rome</strong>
<img alt="" src="_images/Betzyx16_log.png" /></p>
<p>Here again they turn out to be absolutely identical.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is also possible to use the <strong>diffn</strong> operator from the Climate Data Operator (CDO) software collection (several versions are available as <em>modules</em> on Betzy) to compare the contents of two datasets field by field, for instance history or restart NetCDF files: the exit status will be 0 if inputs are the same and 1 if they differ.</p>
<p>This is an example of result for 1-month simulations done with 128 CPUs on Betzy and Lumi confirming that there is no difference in the CAM history files:</p>
<p><img alt="" src="_images/Diffn_Betzy_Lumi.png" /></p>
</div>
</div>
</div></div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="virtual_machine.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">On the Virtual Machine</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="take_home.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Take home messages</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Jean Iaquinta<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>
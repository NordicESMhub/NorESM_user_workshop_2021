
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>On the Virtual Machine &#8212; NorESM User Workshop 2021</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/exercise.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="On Betzy" href="hpc.html" />
    <link rel="prev" title="Objectives of this training" href="content.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">NorESM User Workshop 2021</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Running NorESM in a container
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="content.html">
   Objectives of this training
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     On the Virtual Machine
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="hpc.html">
     On Betzy
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="take_home.html">
   Take home messages
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/virtual_machine.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/NordicESMHub/NorESM_user_workshop_2021"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/NordicESMHub/NorESM_user_workshop_2021/issues/new?title=Issue%20on%20page%20%2Fvirtual_machine.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#from-inside-out">
   From “inside-out”
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#basic-verifications">
     Basic verifications
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#preparation-of-the-necessary-folders-and-input-data">
     Preparation of the necessary folders and input data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pull-the-container-image-and-execute-it">
     Pull the container image and execute it
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-the-container-with-bindings">
     Run the container with bindings
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-a-new-simulation-set-it-up-compile-and-run-it-inside-the-container">
     Create a new simulation, set it up, compile and run it inside the container
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#monitor-your-run">
     Monitor your run
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-time-cost-and-model-throughput">
     Run time, cost and model throughput
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#from-outside-in">
   From “outside-in”
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="on-the-virtual-machine">
<h1>On the Virtual Machine<a class="headerlink" href="#on-the-virtual-machine" title="Permalink to this headline">¶</a></h1>
<div class="section" id="from-inside-out">
<h2>From “inside-out”<a class="headerlink" href="#from-inside-out" title="Permalink to this headline">¶</a></h2>
<p>Login on your own Virtual Machine with the <strong>private SSH key</strong> corresponding to the public key that you provided the Organizers of this Workshop (it does not grant you access to any other Virtual Machine anyway):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">i</span> <span class="o">~/.</span><span class="n">ssh</span><span class="o">/</span><span class="n">YourPrivateSSHkey</span> <span class="n">ubuntu</span><span class="nd">@aaa</span><span class="o">.</span><span class="n">bb</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">ddd</span>
</pre></div>
</div>
<p>Each Virtual Machine features 16 VCPUs + 64GB RAM + 80GB root disk, and comes with:</p>
<ul class="simple">
<li><p>an Operating System (OS) with the default C/C++/FORTRAN compilers</p></li>
<li><p>a Message Passing Interface (MPI) library, required for the hands-on exercise on “outside-in” interaction with the container (but not for “inside-out”)</p></li>
<li><p>Singularity</p></li>
</ul>
<p>already installed, nothing else</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Use the <em>actual path</em> to where your SSH keys are stored on your laptop (instead of <em>~/.ssh/</em>), replace <em>&#64;aaa.bb.cc.ddd</em> by the IP address that you have been allocated, and all use the same user name (<em>ubuntu</em>)</p>
</div>
<div class="section" id="basic-verifications">
<h3>Basic verifications<a class="headerlink" href="#basic-verifications" title="Permalink to this headline">¶</a></h3>
<p>Login on your Virtual Machine and verify that a container engine is available</p>
<div class="exercise admonition" id="Version">
<p class="admonition-title"><span class="caption-number">Exercise 1 </span></p>
<div class="section" id="exercise-content">
<p>Check which version of <strong>Singularity</strong> is installed on your Virtual Machine</p>
</div>
</div><div class="solution dropdown admonition" id="virtual_machine-solution-1">
<p class="admonition-title"><span class="caption-number"></span><a class="reference internal" href="#Version"><span>Solution to </span> Exercise 1</a></p>
<div class="section" id="solution-content">
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>singularity --version
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>singularity version <span class="m">3</span>.8.3
</pre></div>
</div>
</div>
</div><div class="exercise admonition" id="CPU">
<p class="admonition-title"><span class="caption-number">Exercise 2 </span></p>
<div class="section" id="exercise-content">
<p>Check the architecture, model and number of processors available on the Virtual Machine</p>
</div>
</div><div class="solution dropdown admonition" id="virtual_machine-solution-3">
<p class="admonition-title"><span class="caption-number"></span><a class="reference internal" href="#CPU"><span>Solution to </span> Exercise 2</a></p>
<div class="section" id="solution-content">
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>lscpu  
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Architecture:                    x86_64
CPU<span class="o">(</span>s<span class="o">)</span>:                          <span class="m">16</span>
Model name:                      Intel Core Processor <span class="o">(</span>Haswell, no TSX<span class="o">)</span>
CPU MHz:                         <span class="m">2294</span>.608
</pre></div>
</div>
</div>
</div></div>
<div class="section" id="preparation-of-the-necessary-folders-and-input-data">
<h3>Preparation of the necessary folders and input data<a class="headerlink" href="#preparation-of-the-necessary-folders-and-input-data" title="Permalink to this headline">¶</a></h3>
<p>Create the work and archive folders in your <strong>$HOME</strong> directory</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cd $HOME

mkdir work archive 
</pre></div>
</div>
<p>Get the inputdata from Zenodo <img src="https://zenodo.org/badge/DOI/10.5281/zenodo.4683483.svg" height="25"></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">zenodo</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">record</span><span class="o">/</span><span class="mi">4683483</span><span class="o">/</span><span class="n">files</span><span class="o">/</span><span class="n">inputdata_NF2000climo_f19_f19_mg17</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
</pre></div>
</div>
<p>Extract (or untar) all the files from the archive</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tar</span> <span class="n">zxvf</span> <span class="n">inputdata_NF2000climo_f19_f19_mg17</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
</pre></div>
</div>
<p>This will add the inputdata folder on <strong>$HOME</strong> and will be much faster than downloading individual files on-the-fly, hence saving us a lot of time.</p>
</div>
<div class="section" id="pull-the-container-image-and-execute-it">
<h3>Pull the container image and execute it<a class="headerlink" href="#pull-the-container-image-and-execute-it" title="Permalink to this headline">¶</a></h3>
<p>Get the NorESM container from Zenodo <img src="https://zenodo.org/badge/DOI/10.5281/zenodo.5652619.svg" height="25"></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">zenodo</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">record</span><span class="o">/</span><span class="mi">5652619</span><span class="o">/</span><span class="n">files</span><span class="o">/</span><span class="n">NorESM_user_workshop_2021</span><span class="o">.</span><span class="n">sif</span>
</pre></div>
</div>
<p>The download should take less than 1 minute:</p>
<p><img alt="" src="_images/SIF.png" /></p>
<p>Type the following commands to change the access permissions of the .sif file (i.e., to <strong>make it executable</strong>), then start a Singularity container and run an interactive shell within it</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chmod</span> <span class="n">ugo</span><span class="o">+</span><span class="n">rwx</span> <span class="n">NorESM_user_workshop_2021</span><span class="o">.</span><span class="n">sif</span>

<span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="n">NorESM_user_workshop_2021</span><span class="o">.</span><span class="n">sif</span>
</pre></div>
</div>
<p><img alt="" src="_images/Perms.png" /></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">singularity</span> <span class="n">shell</span> <span class="o">--</span><span class="n">contain</span> <span class="n">NorESM_user_workshop_2021</span><span class="o">.</span><span class="n">sif</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Inside the container the Bash shell prompt (<strong>Singularity&gt;</strong>) is different from that on the host (where, depending on the name that was given to your Virtual Machine when it was created, it will be something like <strong>ubuntu&#64;nuw_name:</strong>)</p>
</div>
<div class="exercise admonition" id="Contain">
<p class="admonition-title"><span class="caption-number">Exercise 3 </span></p>
<div class="section" id="exercise-content">
<p>Once inside the container explore, navigate through the folders, try to create new files in the home directory (<strong>/home/ubuntu</strong>), for instance create a file called <strong>text.txt</strong>, what happens?</p>
<p>Now exit the container and try to see whether the <strong>text.txt</strong> file is accessible on the host</p>
</div>
</div><div class="solution dropdown admonition" id="virtual_machine-solution-5">
<p class="admonition-title"><span class="caption-number"></span><a class="reference internal" href="#Contain"><span>Solution to </span> Exercise 3</a></p>
<div class="section" id="solution-content">
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">pwd</span>
touch text.txt
ls
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">exit</span>
ls 
</pre></div>
</div>
<p>You should be able to create new files and new folders inside the container, without any error or warning, however these files and folders will not exist outside</p>
<p>This is because the <strong>- - contain</strong>  flag will use minimal <strong>/dev</strong> and empty other directories (e.g., <strong>/tmp</strong>) instead of sharing filesystems from your host</p>
<p>Without this flag, by default, the <strong>home</strong> directory, the <strong>current working directory</strong>, but also some system folders (<strong>/tmp</strong>, <strong>/proc</strong>, <strong>/sys</strong> and <strong>/dev</strong>) are automatically included inside each container: these are in fact those from the host (and any alteration done from inside the container, voluntarily or not, will be permanent, therefore be very cautious)</p>
</div>
</div></div>
<div class="section" id="run-the-container-with-bindings">
<h3>Run the container with bindings<a class="headerlink" href="#run-the-container-with-bindings" title="Permalink to this headline">¶</a></h3>
<p>To be able to share files and folders between the container and the host, explicit binding paths have to be specified in the format <strong>src:dest</strong>, where <strong>src</strong> and <strong>dest</strong> are paths outside and inside of the container, respectively, separated by a colon (:)</p>
<p>Shared <strong>work</strong> and <strong>archive</strong> directories will allow us to access model outputs from the host, even after the container ceased to exist. Also the shared <strong>inputdata</strong> which was created and populated from the host can be made accessible inside the container</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>singularity shell --bind $HOME/work:/opt/esm/work,$HOME/inputdata:/opt/esm/inputdata,$HOME/archive:/opt/esm/archive NorESM_user_workshop_2021.sif
</pre></div>
</div>
<p>This means for instance that the content of the directory known as <strong>$HOME/archive</strong> on the host can be accessed on <strong>/opt/esm/archive</strong> inside the container, and <em>vice versa</em></p>
</div>
<div class="section" id="create-a-new-simulation-set-it-up-compile-and-run-it-inside-the-container">
<h3>Create a new simulation, set it up, compile and run it inside the container<a class="headerlink" href="#create-a-new-simulation-set-it-up-compile-and-run-it-inside-the-container" title="Permalink to this headline">¶</a></h3>
<p>The source code for NorESM (release 2.0.5) can be found inside the container in <strong>/opt/esm/my_sandbox</strong></p>
<p>A machine named <strong>“virtual”</strong> has already been configured with the correct compilers, libraries and paths inside the container</p>
<div class="exercise admonition" id="Test-case">
<p class="admonition-title"><span class="caption-number">Exercise 4 </span></p>
<div class="section" id="exercise-content">
<ul class="simple">
<li><p><strong>Create a new case</strong> called <strong>“test”</strong> in the <strong>/opt/esm/archive/cases</strong> directory with the <strong>NF2000climo</strong> compset and <strong>f19_f19_mg17</strong> resolution</p></li>
<li><p>Modify (with the <strong>xmlchange</strong> tool) the necessary environment variables to only run the simulation for <strong>1 day</strong></p></li>
<li><p>Change the number of <strong>tasks</strong> so that all the processors available on the Virtual Machine (single node) are used for all the model components (instead of <em>‘NTASKS_ATM’: -2</em>, etc.)</p></li>
<li><p>Then perform the <strong>setup</strong>, <strong>compile</strong> and <strong>run</strong> the simulation</p></li>
</ul>
</div>
</div><div class="solution dropdown admonition" id="virtual_machine-solution-7">
<p class="admonition-title"><span class="caption-number"></span><a class="reference internal" href="#Test-case"><span>Solution to </span> Exercise 4</a></p>
<div class="section" id="solution-content">
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /opt/esm/my_sandbox/cime/scripts/

./create_newcase --case /opt/esm/archive/cases/test --compset NF2000climo --res f19_f19_mg17 --machine virtual --run-unsupported

<span class="nb">cd</span> /opt/esm/archive/cases/test

./xmlchange <span class="nv">STOP_N</span><span class="o">=</span><span class="m">1</span>
./xmlchange <span class="nv">STOP_OPTION</span><span class="o">=</span>ndays
./xmlchange --file env_mach_pes.xml --id NTASKS --val -1

./case.setup

./case.build

./case.submit
</pre></div>
</div>
</div>
</div><p>If everything went well the run will start</p>
<p><img alt="" src="_images/ModelExecutionBegins.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>nohup</strong> is a POSIX command which means “no hang up”, its purpose is to execute a command such that it ignores the HUP (hangup) signal and therefore does not stop when the user logs out (From <a class="reference external" href="https://en.wikipedia.org/wiki/Nohup">https://en.wikipedia.org/wiki/Nohup</a>)</p>
<p>Then you <em>can</em> type:</p>
<ul class="simple">
<li><p><strong>Ctrl+Z</strong> to stop (pause) the program and get back to the shell</p></li>
<li><p><strong>bg</strong> to run it in the background</p></li>
</ul>
<p>You can then <em>if you wish</em> exit the container (with the <strong>exit</strong> command) and re-enter it with the same command that you have used to run it with bindings (singularity shell - - bind … workshop_2021.sif)</p>
</div>
</div>
<div class="section" id="monitor-your-run">
<h3>Monitor your run<a class="headerlink" href="#monitor-your-run" title="Permalink to this headline">¶</a></h3>
<p>To monitor your job <em>from outside the container</em> while it is still running you can open a <strong>2<sup>nd</sup> terminal</strong> and login like on the 1<sup>st</sup> one, then type the following command</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>htop
</pre></div>
</div>
<p><img alt="" src="_images/htop.png" /></p>
<p>On the upper part of the window is displayed information about the CPU and memory usage, and in the bottom part is a table listing the various processes which are running on the Virtual Machine, and in this instance the 16 <em>cesm.exe</em> tasks, their process ID, etc.</p>
<div class="exercise admonition" id="Simulation-progress">
<p class="admonition-title"><span class="caption-number">Exercise 5 </span></p>
<div class="section" id="exercise-content">
<p>Check the simulation progress in the <em>workdir</em></p>
</div>
</div><div class="solution dropdown admonition" id="virtual_machine-solution-9">
<p class="admonition-title"><span class="caption-number"></span><a class="reference internal" href="#Simulation-progress"><span>Solution to </span> Exercise 5</a></p>
<div class="section" id="solution-content">
<p>New output files and log files are created as the model runs, so check for example their size and/or content to get an idea about what is going on during the simulation</p>
<p>Notice how, at the begining of the run, only <strong>finidat_interp_dest.nc</strong> and the <strong>lnd.log</strong> file grow in size as the LAND component is initialized (and interpolations are being performed)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ls -lrt /home/ubuntu/work/test/run
</pre></div>
</div>
<p><img alt="" src="_images/Workdir.png" /></p>
<p>Verify which time steps the CAM component has completed:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tail /home/ubuntu/work/test/run/atm.log*
</pre></div>
</div>
<p><img alt="" src="_images/AtmLog.png" /></p>
<p>(there are 48 time steps per 24h simulation)</p>
<p>You can still use <em>from inside the container</em> the <strong>ps axu</strong> command to monitor the processes running on your Virtual Machine (and in particular those related to your ESM run):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ps axu <span class="p">|</span> grep esm
</pre></div>
</div>
<p><img alt="" src="_images/PS.png" /></p>
</div>
</div></div>
<div class="section" id="run-time-cost-and-model-throughput">
<h3>Run time, cost and model throughput<a class="headerlink" href="#run-time-cost-and-model-throughput" title="Permalink to this headline">¶</a></h3>
<p>After the end of the simulation it is possible to obtain general information about the total run time and cost as well as several metrics to facilitate analysis and comparisons with other runs</p>
<div class="exercise admonition" id="Timing-test">
<p class="admonition-title"><span class="caption-number">Exercise 6 </span></p>
<div class="section" id="exercise-content">
<p>Have a look at the timing profile located in the case directory <strong>from outside the container</strong></p>
</div>
</div><div class="solution dropdown admonition" id="virtual_machine-solution-11">
<p class="admonition-title"><span class="caption-number"></span><a class="reference internal" href="#Timing-test"><span>Solution to </span> Exercise 6</a></p>
<div class="section" id="solution-content">
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat /home/ubuntu/archive/cases/test/timing/cesm_timing.*
</pre></div>
</div>
<p><img alt="" src="_images/TimingTest.png" /></p>
</div>
</div></div>
</div>
<div class="section" id="from-outside-in">
<h2>From “outside-in”<a class="headerlink" href="#from-outside-in" title="Permalink to this headline">¶</a></h2>
<p>Let’s now do the same simulation in a more automated way using the bash script called <strong>“job_vm.sh”</strong> which comes in the container (and can be extracted from <strong>/opt/esm</strong>)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /home/ubuntu

singularity <span class="nb">exec</span> NorESM_user_workshop_2021.sif cp /opt/esm/job_vm.sh .
</pre></div>
</div>
<p>For the sake of convenience this bash script follows the same structure as the Slurm job batch script which will be used on Betzy</p>
<p>This will export several environmental variables (number of nodes, CPUs, etc.), then create the new case, do the setup, compile, run the simulation and generate the timing profile</p>
<p>Submit the job on the Virtual Machine by typing the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bash job_vm.sh
</pre></div>
</div>
<p>This time we use the sequence <strong>mpirun singularity … esm.exe</strong> (instead of <strong>singularity mpirun … esm.exe</strong>)</p>
<div class="exercise admonition" id="Timing-VM">
<p class="admonition-title"><span class="caption-number">Exercise 7 </span></p>
<div class="section" id="exercise-content">
<p>Monitor this run, and at the end compare the timing profile to the one obtained “inside-out”</p>
</div>
</div><div class="solution dropdown admonition" id="virtual_machine-solution-13">
<p class="admonition-title"><span class="caption-number"></span><a class="reference internal" href="#Timing-VM"><span>Solution to </span> Exercise 7</a></p>
<div class="section" id="solution-content">
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat /home/ubuntu/archive/cases/singularity_1x16_NF2000climo_f19_f19_mg17_1_ndays_2021-10-19/timing/cesm_timing.singularity_1x16_NF2000climo_f19_f19_mg17_1_ndays_2021-10-19.999999-999999
</pre></div>
</div>
<p><img alt="" src="_images/Timing-VM.png" /></p>
<p>Notice the similitude of the performance when running “inside-out” (mpirun used inside the container) and “outside-in” (mpirun invoked from outside the container): on a single node machine it virtually makes no difference to the run time and model throughput</p>
</div>
</div><div class="exercise admonition" id="Differences">
<p class="admonition-title"><span class="caption-number">Exercise 8 </span></p>
<div class="section" id="exercise-content">
<p>Can you spot any difference between the outputs of the simulations performed from “inside-out” and “outside-in”, for instance by comparing the <strong>atm.log</strong>s?</p>
</div>
</div><div class="solution dropdown admonition" id="virtual_machine-solution-15">
<p class="admonition-title"><span class="caption-number"></span><a class="reference internal" href="#Differences"><span>Solution to </span> Exercise 8</a></p>
<div class="section" id="solution-content">
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /home/ubuntu
gunzip archive/test/logs/atm.log.*
diff work/singularity_1x16_NF2000climo_f19_f19_mg17_1_ndays_*/run/atm.log.* archive/test/logs/atm.log.*
</pre></div>
</div>
<p><img alt="" src="_images/ATM-LOG.png" /></p>
<p>Apart from expected differences in the case name and creation date/time they are absolutely identical</p>
</div>
</div></div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="content.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Objectives of this training</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="hpc.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">On Betzy</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Jean Iaquinta<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>